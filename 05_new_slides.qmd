---
title: "<br><br>It's not the journey, man..."
subtitle: "It's the apprenticeship"
author:
  - name: Richard Martin
format: 
  revealjs:
    self-contained: true
title-slide-attributes:
  data-background-image: ralph.png
  data-background-size: cover    
css: styles.css
---

```{r}
library(tidyverse)
library(tsibble)
library(conflicted)
library(patchwork)
library(here)
library(gganimate)
library(modelsummary)
library(gt)
conflicts_prefer(dplyr::filter)
font_size=25
set.seed(1)
#functions----------------------
make_fcast <- function(reg_date, regs, tbbl){
  tbbl|>
    mutate(real_completions=`probability of completion`*regs,
           real_date=reg_date+months(`completion time (months)`)
           )
}
my_survplot <- function(mod, dat, grp) {
  plt <- survminer::ggsurvplot(mod,
    dat,
    pval = TRUE,
    censor = FALSE,
    conf.int = FALSE,
    ggtheme = theme_grey(),
    font.title=font_size,
    font.x=font_size,
    font.y=font_size,
    font.tickslab=font_size,
    font.legend=font_size
  ) +
    labs(
      title = grp,
      x = "Months since registration",
      y = "Survival Probability"
    )
}
survival <- read_rds(here("out","survival.rds"))
congestion <- read_rds(here("out","congestion.rds"))
```

## Introduction:

-   An apprenticeship is training in a trade that involves a combination of on-the-job training and technical training in the classroom (aka seats).
-   The NDP have big plans:
    -   "...committing \$1.5 billion to build 26,000 non-market housing units each year."
    -   "... invest \$150 million over three years in SkilledTradesBC to double the trade apprentice seats from the current 26,000 to over 50,000."

## Goals:

1)  Use new apprenticeship registrations as a leading indicator for apprenticeship completions.

2)  Look inside the "black box" of apprenticeship.

    -   What technical training levels are associated with delay and/or attrition?
    -   For those who do not finish how many training levels do they typically complete?

## New registrations: a leading indicator

-   We apply historic transition probabilities to the stream of new apprenticeship registrations.

-   We derive these transition probabilities based on Kaplan-Meier (non-parametric) estimation of historic survival data.

-   The main assumption is that these transition dynamics are stable over time

-   ... likely to fail if government policy changes in a *meaningful* way.

## In other words, we assume...

-   The arrival rate of new registrants is **the** constraint on the "production" of Journeypersons.

-   "Production" scales up/down with the arrival rate of registrants, without changes in attrition or delay.

![](factory.webp)

## How wrong is the assumption?

-  Doubling cohort size $\sim$ completion rate decreases by 1.3%.
-  Doubling cohort size $\sim$ duration increases by 3.6 months.


```{r, results='asis'}
prop_complete_mod <- lm(prop_complete~log(`cohort size`)+ `mean unemployment rate subsequent 4 years`, data=congestion)
mean_delay_mod <- lm(mean_delay~log(`cohort size`)+`mean unemployment rate subsequent 4 years`, data=congestion)
models=list("Proportion that complete"=prop_complete_mod, 
            "Apprenticeship Duration"=mean_delay_mod)

stars <- c(`***` = 0.001, `**` = 0.01, `*` = 0.05, ` ` = 0.1)
table <- modelsummary(models, output = "gt", 
             statistic = "p.value", 
             stars=stars,
             gof_map = c("nobs", "r.squared", "adj.r.squared"))
table <- table %>%
  tab_style(
    style = list(
      cell_fill(color = "grey95")
    ),
    locations = cells_body(rows = 3, columns = 1:3)
  )
table%>%
  tab_options(table.font.size = 16) %>%
  as_raw_html() %>%
  cat()
```

## A simple forecast based on registrations:

-   Assume for the sake of argument that 50% of those who register complete their apprenticeship, and they all take exactly 48 months to complete.
-   We would form our forecast by adding 48 months to the registration date, and divide the number of new registrants by 2.

## A simple forecast:

```{r, fig.retina=2, cache=TRUE}
colors <- c("New Registrations" = "blue", 
            "Simple forecast of completions" = "red",
            "More realistic forecast of completions"="purple")
reg_date <- seq.Date(today()-months(48), today(), by = "month")
new_regs <- 100+10*rnorm(49)
time <- 1:49
tbbl <- tibble(reg_date, new_regs, time)|>
  mutate(simple_date=reg_date+months(48),
         simple_completions=new_regs*.5)

p <- ggplot(tbbl)+
  geom_line(aes(reg_date, new_regs, colour="New Registrations"))+
  geom_line(aes(simple_date, simple_completions, colour="Simple forecast of completions"))+
  geom_point(aes(reg_date, new_regs)) +
  geom_point(aes(simple_date, simple_completions))+
  labs(x=NULL, y=NULL, colour=NULL, title="New Registrations and Completions")+
  scale_colour_manual(values=colors)+
  theme(text=element_text(size=18))+
  annotate("segment", 
           x = reg_date[time], 
           xend = reg_date[time], 
           y = new_regs[time], 
           yend = tbbl$simple_completions[time], 
           lty=2, 
           arrow = arrow(length = unit(0.1, "inches")))+
  annotate("segment", 
           x = reg_date[time], 
           xend = tbbl$simple_date[time], 
           y = tbbl$simple_completions[time], 
           yend = tbbl$simple_completions[time], 
           lty=2, 
           arrow = arrow(length = unit(0.1, "inches")))+
  annotate("text", 
           x = reg_date[time]-months(4), 
           y = (tbbl$new_regs[time]+tbbl$simple_completions[time])/2, 
           label = "-50%")+
  annotate("text", 
           x = reg_date[time]+months(24), 
           y = .95*tbbl$simple_completions[time], 
           label = "+48 months")+
  transition_reveal(time)

animate(p, renderer = gifski_renderer())

```

## Simple vs. slightly more realistic transistion probabilities.

```{r}
simple <- tibble(`completion time`="48 months", `probability of completion`=.5)
simple_plt <- ggplot(simple, aes(`completion time`, `probability of completion`))+
  geom_col(width = .05)+
  theme(text=element_text(size=18))+
  labs(title="50% completion at 48 months")

real <- tibble(`completion time (months)`=36:60,
                   x=seq(-3,3, length=length(`completion time (months)`)),
                   `probability of completion` = .5*dnorm(x)/sum(dnorm(x)))
                   
real_plt <- ggplot(real, aes(`completion time (months)`, `probability of completion`))+
  geom_col()+
  theme(text=element_text(size=18))+
  labs(title="50% completion, spread out")

simple_plt+real_plt
```

```{r}
more_realistic <- tbbl|>
  select(reg_date, new_regs, time)|>
  mutate(transistion_probs=list(real))|>
  mutate(completions=pmap(list(reg_date, new_regs, transistion_probs), make_fcast))|>
  select(completions)|>
  unnest(c(completions))|>
  group_by(real_date)|>
  summarize(real_completions=sum(real_completions))

more_realistic <- more_realistic|>
  full_join(tbbl, by=c("real_date"="simple_date"))|>
  na.omit()|>
  mutate(simple_date=real_date)|>
  filter(time %in% 12:36)
 
```

## Simple vs more realistic forecast:

```{r, fig.retina=2, cache=TRUE}
p <- ggplot(more_realistic)+
  geom_line(aes(reg_date, new_regs, colour="New Registrations"))+
  geom_line(aes(simple_date, simple_completions, colour="Simple forecast of completions"))+
  geom_line(aes(real_date, real_completions, colour="More realistic forecast of completions"))+
  geom_point(aes(reg_date, new_regs, colour="New Registrations")) +
  geom_point(aes(simple_date, simple_completions, colour="Simple forecast of completions"))+
  geom_point(aes(real_date, real_completions, colour="More realistic forecast of completions"))+
  labs(x=NULL, y=NULL, title="New Registrations and Completions")+
  scale_colour_manual(values=colors)+ 
  theme(text=element_text(size=18))+
  transition_reveal(time)

animate(p, renderer = gifski_renderer())
```

## Estimation:

-   We use Kaplan-Meier and historical completion data to estimate, rather than assume, the transition probabilities.
-   The transition probabilities are the joint probability of "survival thus far" (not yet a Journeyperson) and the instantaneous probability of "death" (graduation).

1)  Survival Curve: the probability of "survival thus far".
2)  Hazard Rate: the instantaneous probability of "death", conditional on survival thus far.

## 

```{r, fig.height=8, fig.retina=2}
#| layout-ncol: 2
#| column: page
plt <- survival|>
    filter(trade_desc=="Powerline Technician")|>
    mutate(km_plot = pmap(list(km_model_last8, data, trade_desc), my_survplot))
plt$km_plot[[1]]

joint <- survival|>
  filter(trade_desc=="Powerline Technician")|>
  pull(surv_dat)

ggplot(joint[[1]], aes(time, joint))+
  geom_col()+
  theme(text=element_text(size=25))+
  labs(x="Months since registration",
       y="Probability of completion",
       title="Transition Probabilities")
```

## 

```{r, fig.height=8, fig.retina=2}
#| layout-ncol: 2
#| column: page
plt <- survival|>
    filter(trade_desc=="Plumber")|>
    mutate(km_plot = pmap(list(km_model_last8, data, trade_desc), my_survplot))
plt$km_plot[[1]]

joint <- survival|>
  filter(trade_desc=="Plumber")|>
  pull(surv_dat)

ggplot(joint[[1]], aes(time, joint))+
  geom_col()+
  labs(x="Months since registration",
       y="Probability of completion",
       title="Transition Probabilities")+
  theme(text=element_text(size=25))

```

## Are transition dynamics stable?

```{r, fig.height=8, fig.retina=2}
#| layout-ncol: 2
#| column: page
plt <- survival|>
    filter(trade_desc=="Powerline Technician")|>
    mutate(km_plot = pmap(list(km_split_model, data, trade_desc), my_survplot))
plt$km_plot[[1]]

plt <- survival|>
    filter(trade_desc=="Plumber")|>
    mutate(km_plot = pmap(list(km_split_model, data, trade_desc), my_survplot))
plt$km_plot[[1]]
```

-   Yes: we can be more confident in forecasts.
-   No: are we doing better or worse over time?

## The Apps:

-   Forecasting completions
-   Inside the black box

## Potential co-op opportunities

-   BC Public Service Co-op Employment Program: [internship-co-op opportunities](https://www2.gov.bc.ca/gov/content/careers-myhr/job-seekers/internship-co-op-opportunities/co-op)
-   Check your Co-op & Career Services 
-   Check my colleague's LinkedIn profile: [Sazid Hasan](https://www.linkedin.com/in/sazidhasan/)
