---
title: "Forecasting Apprentice Completions"
author: "Richard Martin"
format: 
  revealjs:
    self-contained: true
---

```{r}
library(tidyverse)
library(tsibble)
library(conflicted)
library(patchwork)
library(here)
library(gganimate)
conflicts_prefer(dplyr::filter)
font_size=18
#functions----------------------
make_fcast <- function(reg_date, regs, tbbl){
  tbbl|>
    mutate(real_completions=`probability of completion`*regs,
           real_date=reg_date+months(`completion time (months)`)
           )
}
my_survplot <- function(mod, dat, grp) {
  plt <- survminer::ggsurvplot(mod,
    dat,
    pval = TRUE,
    censor = FALSE,
    conf.int = FALSE,
    ggtheme = theme_grey(),
    font.title=font_size,
    font.x=font_size,
    font.y=font_size,
    font.tickslab=font_size,
    font.legend=font_size
  ) +
    labs(
      title = grp,
      x = "Months since registration",
      y = "Survival Probability"
    )
}
survival <- read_rds(here("out","survival.rds"))
```

## Introduction

-   The goal is to forecast apprentice completions in BC.
-   We could use the historic completions and standard time series forecasting techniques, but...

![the road ahead might not look like the road behind](blacked_out.jpg)

## Apprentice registrations are a leading indicator of apprentice completions.

![road signs: a leading indicator of road direction](with_signs.jpg)

## A simple forecast based on registrations:

-   Assume for the sake of argument that 50% of those who register complete their apprenticeship, and they all take exactly 48 months to complete.
-   We would form our forecast by adding 48 months to the registration date, and divide the number of new registrants by 2.

## A simple forecast:

```{r, fig.retina=2, cache=TRUE}
colors <- c("New Registrations" = "blue", 
            "Simple forecast of completions" = "red",
            "More realistic forecast of completions"="purple")
reg_date <- seq.Date(today()-months(48), today(), by = "month")
new_regs <- 10+2*rnorm(49)
time <- 1:49
tbbl <- tibble(reg_date, new_regs, time)|>
  mutate(simple_date=reg_date+months(48),
         simple_completions=new_regs*.5)

p <- ggplot(tbbl)+
  geom_line(aes(reg_date, new_regs, colour="New Registrations"))+
  geom_line(aes(simple_date, simple_completions, colour="Simple forecast of completions"))+
  labs(x=NULL, y=NULL, colour=NULL, title="New Registrations and Completions")+
  scale_colour_manual(values=colors)+
  annotate("segment", 
           x = reg_date[time], 
           xend = reg_date[time], 
           y = new_regs[time], 
           yend = tbbl$simple_completions[time], 
           lty=2, 
           arrow = arrow(length = unit(0.1, "inches")))+
  annotate("segment", 
           x = reg_date[time], 
           xend = tbbl$simple_date[time], 
           y = tbbl$simple_completions[time], 
           yend = tbbl$simple_completions[time], 
           lty=2, 
           arrow = arrow(length = unit(0.1, "inches")))+
  annotate("text", 
           x = reg_date[time]-months(4), 
           y = (tbbl$new_regs[time]+tbbl$simple_completions[time])/2, 
           label = "-50%")+
  annotate("text", 
           x = reg_date[time]+months(24), 
           y = .95*tbbl$simple_completions[time], 
           label = "+48 months")

p +
  geom_point(aes(reg_date, new_regs)) +
  geom_point(aes(simple_date, simple_completions))+
  transition_reveal(time)

```


## Simple vs. slightly more realistic transistion probabilities.

```{r}
simple <- tibble(`completion time`="48 months", `probability of completion`=.5)
simple_plt <- ggplot(simple, aes(`completion time`, `probability of completion`))+
  geom_col(width = .05)+
  labs(title="50% completion rate, all at 48 months")

real <- tibble(`completion time (months)`=36:60,
                   x=seq(-3,3, length=length(`completion time (months)`)),
                   `probability of completion` = .5*dnorm(x)/sum(dnorm(x)))
                   
real_plt <- ggplot(real, aes(`completion time (months)`, `probability of completion`))+
  geom_col()+
  labs(title="50% completion rate, centered at 48 months.")

simple_plt+real_plt
```

```{r}
more_realistic <- tbbl|>
  select(reg_date, new_regs, time)|>
  mutate(transistion_probs=list(real))|>
  mutate(completions=pmap(list(reg_date, new_regs, transistion_probs), make_fcast))|>
  select(completions)|>
  unnest(c(completions))|>
  group_by(real_date)|>
  summarize(real_completions=sum(real_completions))



more_realistic <- more_realistic|>
  full_join(tbbl, by=c("real_date"="simple_date"))|>
  na.omit()|>
  mutate(simple_date=real_date)|>
  filter(time %in% 12:36)
 
```

## Simple vs more realistic forecast:

```{r, fig.retina=2, cache=TRUE}
p <- ggplot(more_realistic)+
  geom_line(aes(reg_date, new_regs, colour="New Registrations"))+
  geom_line(aes(simple_date, simple_completions, colour="Simple forecast of completions"))+
  geom_line(aes(real_date, real_completions, colour="More realistic forecast of completions"))+
  labs(x=NULL, y=NULL, title="New Registrations and Completions")+
  scale_colour_manual(values=colors)

p + 
  geom_point(aes(reg_date, new_regs, colour="New Registrations")) +
  geom_point(aes(simple_date, simple_completions, colour="Simple forecast of completions"))+
  geom_point(aes(real_date, real_completions, colour="More realistic forecast of completions"))+
  transition_reveal(time)

```

## Estimation:

-   We use historical completion data to estimate, rather than assume, the transition probabilities.
-   Kaplan-Meier estimation yields the two components necessary.

1)  Survival Curve: the probability of "surviving" (remaining an apprentice) for every duration post registration.
2)  Hazard Rate: the instantaneous probability of "death" (becoming a journeyperson), conditional on survival thus far.

## Powerline Technicians

```{r, fig.height=8, fig.retina=2}
#| layout-ncol: 2
#| column: page
plt <- survival|>
    filter(trade_desc=="Powerline Technician")|>
    mutate(km_split_plot = pmap(list(km_split_model, data, trade_desc), my_survplot))
plt$km_split_plot[[1]]

joint <- survival|>
  filter(trade_desc=="Powerline Technician")|>
  pull(surv_dat)

ggplot(joint[[1]], aes(time, joint))+
  geom_col()+
  labs(x="Months since registration",
       y="Probability of completion",
       title="Transition Probabilities")+
  theme(text=element_text(size=font_size))

```

## Plumbers:

```{r, fig.height=8, fig.retina=2}
#| layout-ncol: 2
#| column: page
plt <- survival|>
    filter(trade_desc=="Plumber")|>
    mutate(km_split_plot = pmap(list(km_split_model, data, trade_desc), my_survplot))
plt$km_split_plot[[1]]

joint <- survival|>
  filter(trade_desc=="Plumber")|>
  pull(surv_dat)

ggplot(joint[[1]], aes(time, joint))+
  geom_col()+
  labs(x="Months since registration",
       y="Probability of completion",
       title="Transition Probabilities")+
  theme(text=element_text(size=font_size))

```

##   Are transition dynamics stable over time?

-   If yes, more confident that future dynamics will look like historical dynamics.
-   If no, are we doing better or worse over time, regarding the conversion of apprentices to journey-persons?

    1) Is the proportion that (eventually) complete changing over time? (1-height of flat part of survival curve)
    2) Is the distribution of completion times changing over time? (the closer the curves are to the y-axis, the quicker the completion.)
    
##  The App:



